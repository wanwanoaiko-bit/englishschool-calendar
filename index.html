<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>英語教室 予約カレンダー（生徒用）</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 20px; }
    #calendar { max-width: 900px; margin: auto; }

    /* モーダルのデザイン */
    .modal-bg {
      display: none;
      position: fixed;
      top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
    }
    .modal input, .modal textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 5px;
      box-sizing: border-box;
    }
    .modal button {
      margin-top: 10px;
      padding: 5px 10px;
    }
  </style>
</head>
<body>
  <h1>英語教室 予約カレンダー（生徒用）</h1>
  <div id="calendar"></div>

  <!-- モーダルフォーム -->
  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <h3>予約情報を入力してください</h3>
      <input type="text" id="studentName" placeholder="お名前">
      <input type="email" id="studentEmail" placeholder="メールアドレス">
      <textarea id="studentMemo" placeholder="質問・ご要望（空欄OK）"></textarea>
      <button id="submitBtn">予約する</button>
      <button id="cancelBtn">キャンセル</button>
    </div>
  </div>

<script>
const IS_STUDENT_VIEW = true;
let selectedEvent = null;

document.addEventListener("DOMContentLoaded", function () {
  const calendarEl = document.getElementById("calendar");

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    slotMinTime: "08:00:00",
    slotMaxTime: "22:00:00",
    allDaySlot: false,
    eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false },

    // ←ここにGASのURLを必ず閉じて入力
    events: "https://script.google.com/macros/s/AKfycbxSPt3DoIQtPe1-8NfQ5vbc6_FMMLrd3CxAcqYZ4ZLyHpX5E68LuTtG7J93R_RWxq2l/exec",

    eventDidMount: function(info) {
      if (IS_STUDENT_VIEW) {
        if (info.event.title === "空き") {
          info.event.setProp("title", "○");
        } else {
          info.event.setProp("title", "×");
        }
      }
    },

    eventClick: function(info) {
      if (IS_STUDENT_VIEW && info.event.title !== "○") {
        alert("この枠はすでに予約されています");
        return;
      }
      selectedEvent = info.event;
      document.getElementById("modalBg").style.display = "flex";
    }
  });

  calendar.render();

  // モーダルボタン
  document.getElementById("cancelBtn").onclick = function() {
    document.getElementById("modalBg").style.display = "none";
    selectedEvent = null;
  };

  document.getElementById("submitBtn").onclick = function() {
    const name = document.getElementById("studentName").value.trim();
    const email = document.getElementById("studentEmail").value.trim();
    const memo = document.getElementById("studentMemo").value.trim();

    if (!name || !email) { alert("名前とメールは必須です"); return; }

    fetch("https://script.google.com/macros/s/AKfycbxSPt3DoIQtPe1-8NfQ5vbc6_FMMLrd3CxAcqYZ4ZLyHpX5E68LuTtG7J93R_RWxq2l/exec", {
  method: "POST",
  body: JSON.stringify({
    date: selectedEvent.startStr.split("T")[0],
    start: new Date(selectedEvent.start).toISOString(), // UTCに統一
    end: new Date(selectedEvent.end).toISOString(),
    name: name,
    email: email,
    memo: memo
  })
})
    .then(res => res.text())
    .then(res => {
      if (res === "OK") {
        selectedEvent.setProp("title", "×");
        document.getElementById("modalBg").style.display = "none";
        document.getElementById("studentName").value = "";
        document.getElementById("studentEmail").value = "";
        document.getElementById("studentMemo").value = "";
        alert("予約が完了しました！");
      } else {
        alert("すでに予約済みです");
      }
    });
  };
});
</script>
</body>
</html>
