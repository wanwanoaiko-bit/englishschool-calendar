<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>英語教室 予約カレンダー</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

<style>
body { font-family:sans-serif; margin:20px; }
#calendar { max-width:900px; margin:auto; }
#daySlots { max-width:900px; margin:20px auto; }

.slot {
  padding:10px;
  margin:5px 0;
  border-radius:6px;
  cursor:pointer;
}
.free { background:#e6ffe6; }
.full { background:#ffe6e6; color:#888; }
</style>
</head>

<body>

<h2>英語教室 予約</h2>

<div id="calendar"></div>
<div id="daySlots"></div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxSPt3DoIQtPe1-8NfQ5vbc6_FMMLrd3CxAcqYZ4ZLyHpX5E68LuTtG7J93R_RWxq2l/exec";

let calendar;

document.addEventListener("DOMContentLoaded", () => {

  fetch(GAS_URL)
    .then(r => r.json())
    .then(events => {

      // 空きがある日付だけを抽出
      const freeDates = new Set();
      events.forEach(e => {
        if (e.title === "空き") {
          freeDates.add(e.start.substr(0,10));
        }
      });

      // 背景イベント（青い日付）に変換
      const bgEvents = [...freeDates].map(d => ({
        start: d,
        end: d,
        display: "background",
        backgroundColor: "#cce5ff"
      }));

      calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
        initialView: "dayGridMonth",
        locale: "ja",
        events: bgEvents,
        dateClick(info){
          loadDay(info.dateStr);
        }
      });

      calendar.render();
    });

});

// 指定日の時間枠を取得
function loadDay(date){
  fetch(GAS_URL)
    .then(r=>r.json())
    .then(events=>{
      const dayEvents = events.filter(e => e.start.startsWith(date));

      let html = `<h3>${date} の予約可能時間</h3>`;

      if(dayEvents.length===0){
        html += "この日は予約枠がありません";
      }

      dayEvents.forEach(e=>{
        const start = e.start.substr(11,5);
        const end   = e.end.substr(11,5);

        if(e.title==="空き"){
          html += `<div class="slot free" onclick="reserve('${e.start}','${e.end}')">
                    ${start} - ${end}
                  </div>`;
        } else {
          html += `<div class="slot full">
                    ${start} - ${end}（予約済）
                  </div>`;
        }
      });

      document.getElementById("daySlots").innerHTML = html;
    });
}

// 予約
function reserve(start,end){
  const name = prompt("お名前を入力してください");
  const email = prompt("メールアドレスを入力してください");

  if(!name || !email) return;

  fetch(GAS_URL,{
    method:"POST",
    body:JSON.stringify({ start,end,name,email })
  })
  .then(r=>r.text())
  .then(r=>{
    if(r==="OK"){
      alert("予約完了しました");
      loadDay(start.substr(0,10));
      location.reload(); // ← 青い日付を更新
    } else {
      alert("すでに予約されています");
    }
  });
}
</script>


</body>
</html>
